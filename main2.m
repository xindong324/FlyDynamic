clear all;
close all;
clc

%%--------------所给数据及矩阵将需要插值求出的气动数据设为全局变量------------------%%
global given_Alpha given_Elevator given_Cz given_Cx given_Cm given_Cl given_Cn given_Cl_delta_a given_Cl_delta_r
global given_Cn_delta_a given_Cn_delta_r given_throtte_000 given_throtte_077 given_throtte_100
global given_Cxq given_Cyr given_Cyp given_Czq given_Clr given_Clp given_Cmq given_Cnr given_Cnp given_delta_beta given_beta given_height given_mah
global m g c_ S b r2d H rou Ix Iy Iz Ixz V0 Mah0
global Result_alpha Result_elevator Result_Throtte T resultalfaelevator R g0

%--------------地球半径，地面的重力加速度--------------%
R = 6356766;g0 = 9.80665;

%-------飞机的常数（国际单位制）---------%
m = 9298.643584999898;
c_= 3.4503;S = 27.8709;b = 9.144;r2d=57.29577951;

%-------飞机的惯性数据（国际单位制）---------%
Ix = 12874.8446;  Iy = 75673.6077;  Iz = 85552.0953;  Ixz = 1331.4130;  Isum=Ix*Iz-Ixz^2;

%--------------F-16的气动参数数据--------------%
given_Alpha = [-10 -5 0 5 10 15 20 25 30 35 40 45];
given_Elevator = [-24 -12 0	12 24];
given_Cz =[0.7700 0.2410 -0.1000 -0.4160 -0.7310 -1.0530 -1.3660 -1.6460 -1.9170 -2.1200 -2.2480 -2.2290];
given_Cx = [-0.099	-0.048	-0.022	-0.04	-0.083
    -0.081	-0.038	-0.02	-0.038	-0.073
    -0.081	-0.04	-0.021	-0.039	-0.076
    -0.063	-0.021	-0.004	-0.025	-0.072
    -0.025	 0.016	 0.032	 0.006	-0.046
    0.044	 0.083	 0.094	 0.062	 0.012
    0.097	 0.127	 0.128	 0.087	 0.024
    0.113	 0.137	 0.13	 0.085	 0.025
    0.145	 0.162	 0.154	 0.1	 0.043
    0.167	 0.177	 0.161	 0.11	 0.053
    0.174	 0.179	 0.155	 0.104	 0.047
    0.166	 0.167	 0.138	 0.091	 0.04];
given_Cm = [0.205	 0.081	-0.046	-0.174	-0.259
    0.168	 0.077	-0.02	-0.145	-0.202
    0.186	 0.107	-0.009	-0.121	-0.184
    0.196	 0.11	-0.005	-0.127	-0.193
    0.213	 0.11	-0.006	-0.129	-0.199
    0.251	 0.141	 0.01	-0.102	-0.15
    0.245	 0.127	 0.006	-0.097	-0.16
    0.238	 0.119	-0.001	-0.113	-0.167
    0.252	 0.133	 0.014	-0.087	-0.104
    0.231  0.108	 0	    -0.084	-0.076
    0.198	 0.081	-0.013	-0.069	-0.041
    0.192	 0.093	 0.032	-0.006	-0.005];
given_Cl = [0	-0.001	-0.003	-0.001	 0	     0.07	 0.009
    0	-0.004	-0.009	-0.01	-0.01	-0.01	-0.011
    0	-0.008	-0.017	-0.02	-0.022	-0.023	-0.023
    0	-0.012	-0.024	-0.03	-0.034	-0.034	-0.037
    0	-0.016	-0.03	-0.039	-0.047	-0.049	-0.05
    0	-0.019	-0.034	-0.044	-0.046	-0.046	-0.047
    0	-0.02	-0.04	-0.05	-0.059	-0.068	-0.074
    0	-0.02	-0.037	-0.049	-0.061	-0.071	-0.079
    0	-0.015	-0.016	-0.023	-0.033	-0.06	-0.091
    0	-0.008	-0.002	-0.006	-0.036	-0.058	-0.076
    0	-0.013	-0.1	-0.014	-0.035	-0.062	-0.077
    0	-0.015	-0.19	-0.027	-0.035	-0.059	-0.076];
given_Cn = [0	0.018	0.038	0.056	0.064	0.074	0.079
    0	0.019	0.042	0.057	0.077	0.086	0.09
    0	0.018	0.042	0.059	0.076	0.093	0.106
    0	0.019	0.042	0.058	0.074	0.089	0.106
    0	0.019	0.043	0.058	0.073	0.08	0.096
    0	0.018	0.039	0.053	0.057	0.062	0.08
    0	0.013	0.03	0.032	0.029	0.049	0.068
    0	0.007	0.017	0.012	0.007	0.022	0.03
    0	0.004	0.004	0.002	0.012	0.028	0.064
    0  -0.014  -0.035  -0.046  -0.034  -0.012	0.015
    0  -0.017  -0.047  -0.071  -0.065  -0.002	0.011
    0  -0.033  -0.057  -0.073  -0.041  -0.013  -0.001];
given_Cl_delta_a = [-0.041	-0.041	-0.042	-0.04	-0.043	-0.044	-0.043
    -0.052	-0.053	-0.053	-0.052	-0.049	-0.048	-0.049
    -0.053	-0.053	-0.052	-0.051	-0.048	-0.048	-0.047
    -0.056	-0.053	-0.051	-0.052	-0.049	-0.047	-0.045
    -0.05	-0.05	-0.049	-0.048	-0.043	-0.042	-0.042
    -0.056	-0.051	-0.049	-0.048	-0.042	-0.041	-0.037
    -0.082	-0.066	-0.043	-0.042	-0.042	-0.02	-0.003
    -0.059	-0.043	-0.035	-0.037	-0.036	-0.028	-0.013
    -0.042	-0.038	-0.026	-0.031	-0.025	-0.013	-0.01
    -0.038	-0.027	-0.016	-0.026	-0.021	-0.014	-0.003
    -0.027	-0.023	-0.018	-0.017	-0.016	-0.011	-0.007
    -0.017	-0.016	-0.014	-0.012	-0.011	-0.01	-0.008];
given_Cl_delta_r = [0.005	0.007	0.013	0.018	0.015	0.021	0.023
    0.017	0.016	0.013	0.015	0.014	0.011	0.01
    0.014	0.014	0.011	0.015	0.013	0.01	0.011
    0.01    0.014	0.012	0.014	0.013	0.011	0.011
    -0.005	0.013	0.011	0.014	0.012	0.01	0.011
    0.009	0.009	0.009	0.014	0.011	0.009	0.01
    0.019	0.012	0.008	0.014	0.011	0.008	0.008
    0.005	0.005	0.005	0.015	0.01	0.01	0.01
    0	    0	   -0.002	0.013	0.008	0.006	0.006
    -0.005	0.004	0.005	0.011	0.008	0.005	0.014
    -0.011	0.009	0.003	0.006	0.007	0	    0.02
    0.008	0.007	0.005	0.001	0.003	0.001	0    ];
given_Cn_delta_a = [0.001	 0.002	-0.006	-0.011	-0.015	-0.024	-0.022
    -0.027	-0.014	-0.008	-0.011	-0.015	-0.01	 0.002
    -0.017	-0.016	-0.006	-0.01	-0.014	-0.004	-0.003
    -0.013	-0.016	-0.006	-0.009	-0.012	-0.002	-0.005
    -0.012	-0.014	-0.005	-0.008	-0.011	-0.001	-0.003
    -0.016	-0.019	-0.008	-0.006	-0.008	 0.003	-0.001
    0.001	-0.021	-0.005	 0	    -0.002	 0.014	-0.009
    0.017	 0.002	 0.007	 0.004	 0.002	 0.006	-0.009
    0.011	 0.012	 0.004	 0.007	 0.006	-0.001	-0.001
    0.017	 0.015	 0.007	 0.1	 0.012	 0.004	 0.003
    0.008	 0.015	 0.006	 0.004	 0.011	 0.004	-0.002
    0.016	 0.011	 0.006	 0.1	 0.011	 0.006	 0.001];
given_Cn_delta_r = [-0.018	-0.028	-0.037	-0.048	-0.043	-0.052	-0.062
    -0.052	-0.051	-0.041	-0.045	-0.044	-0.034	-0.034
    -0.052	-0.043	-0.038	-0.045	-0.041	-0.036	-0.027
    -0.052	-0.046	-0.04	-0.045	-0.041	-0.036	-0.028
    -0.054	-0.045	-0.04	-0.044	-0.04	-0.035	-0.027
    -0.049	-0.049	-0.038	-0.045	-0.038	-0.028	-0.027
    -0.059	-0.057	-0.037	-0.047	-0.034	-0.024	-0.023
    -0.051	-0.052	-0.03	-0.048	-0.035	-0.023	-0.023
    -0.03	-0.03	-0.027	-0.049	-0.035	-0.02	-0.019
    -0.037	-0.033	-0.024	-0.045	-0.029	-0.016	-0.009
    -0.026	-0.03	-0.019	-0.033	-0.022	-0.01	-0.025
    -0.013	-0.008	-0.013	-0.016	-0.009	-0.014	-0.01];
given_throtte_000=[1060	  670	 880	 1140	1500	1860
    635	  425	 690	 1010	1330	1700
    60	  25	 345	 755	1130	1525
    -1020	 -710	-300	 350	910	    1360
    -2700	 -1900	-1300	-247	600	    1100
    -3600	 -1400	-595	-342   -200	    700];
given_throtte_077=[12680	9150	6200	3950	2450	1400
    12680	9150	6313	4040	2470	1400
    12610	9312	6610	4290	2600	1560
    12640	9839	7090	4660	2840	1660
    12390	10176	7750	5320	3250	1930
    11680	9848	8050	6100	3800	2310];
given_throtte_100=[20000	15000	10800	7000	4000	2500
    21420	15700	11225	7323	4435	2600
    22700	16860	12250	8154	5000	2835
    24240	18910	13760	9285	5700	3215
    26070	21075	15975	11115	6860	3950
    28886	23319	18300	13484	8642	5057];

given_Cxq = [-0.267 -0.11 0.308 1.34 2.08 2.91 2.76 2.05 1.5 1.49 1.83 1.21];
given_Cyr = [0.882 0.852 0.876 0.958 0.962 0.974 0.819 0.483 0.59 1.21 -0.493 -1.04];
given_Cyp = [-0.108 -0.108 -0.188 0.11 0.258 0.226 -0.344 0.362 0.611 0.529 0.298 -2.27];
given_Czq = [-8.8 -25.8 -28.9 -31.4 -31.2 -30.7 -27.7 -28.2 -29 -29.8 -38.3 -35.3];
given_Clr = [-0.126 -0.126 0.063 0.113 0.208 0.23 0.319 0.437 0.68 0.1 0.447 -0.33];
given_Clp = [-0.36 -0.359 -0.443 -0.42 -0.383 -0.375 -0.329 -0.294 -0.23 -0.21 -0.12 -0.1];
given_Cmq = [-7.21 -0.54 -5.23 -5.26 -6.11 -6.64 -5.69 -6 -6.2 -6.4 -6.6 -6];
given_Cnr = [-0.38 -0.363 -0.378 -0.386 -0.37 -0.453 -0.55 -0.582 -0.595 -0.637 -1.02 -0.804];
given_Cnp = [0.061 0.052 0.052 -0.012 -0.013 -0.024 0.05 0.15 0.13 0.158 0.24 0.15];

given_delta_beta = [-30	-20	-10	0 10 20	30];
given_beta = [0	5 10 15	20	25	30];

%%---------发动机推力插值，（英美单位制）-------------%%
given_height=[0	10000 20000	30000 40000	50000];
given_mah=[0 0.2 0.4 0.6 0.8 1]';

%%---------飞机的飞行状态，速度（m/s）；高度(m)-------------%%
state = [50 0
    80 0
    100 0
    110 1000
    120 1000
    130 1000
    140 1000
    150 5000
    160 5000
    170 5000
    180 10000
    190 10000
    200 10000
    210 10000
    220 11000
    230 11000
    240 11000
    250 12000
    260 13000
    270 14000
    280 15000];

%%---------------------------------------------------------------%%
%%------------------以下的for循环是飞机的配平程序------------------%%
%%---------飞机的配平程序求得攻角、升降舵偏角、油门开度-------------%%
%%---------------------------------------------------------------%%
for i=1:1:21
    H = state(i,2);
    V0 = state(i,1);
    
    %海平面大气密度%
    rou0 = 1.225;
    
%%---------使用ussa76标准大气模型求空气密度和声速-------------%%    
    %大气分层的几个分层点%
    h1 = 11019.1;
    h2 = 20063.1;
    
    g = g0*(R/(R + H))^2;
    
    %----------计算温度，大气密度-----------%
    h_p = R*H/((R + H)*1000);
    if H>=0 && H<=h1;
        WW = 1-h_p/44.3308;
        T = 288.15*WW;
        rou = rou0*WW^4.2559;
    elseif H>=h1 && H<=h2;
        WW = exp((14.9647-h_p)/6.3416);
        T = 216.650;
        rou = 1.5898*10^(-1)*rou0*WW;
    else
        WW = 0;
        T = 0*WW;
        rou = 0;
    end
    
    %-----------计算声速---------------%
    a = 20.0468*T^0.5;
    Mah0=V0/a;
            
    %%---------根据Z轴力平衡，Y轴力矩平衡进行配平-------------%%
    for r2dalpha=0:5:45%给出一定范围，在此范围内搜寻
        x=fsolve('trimfunction',r2dalpha,optimset('Display','off'));
        if abs(trimfunction(x))<1e-8  %使Y轴的力和Z轴的力矩同时达到平衡
            Result_alpha = x;
            break;
        end
    end
    alpha=Result_alpha/r2d;

 %%---------根据F-16的气动参数表求解升降舵偏角-------------%%  
    Cz0=interp1(given_Alpha,given_Cz,Result_alpha,'spline'); 
    elevator=25/0.19*(Cz0+m*g*cos(alpha)/(0.5*rou*V0^2*S));
    Result_elevator=elevator;
    
 %%---------将每一种飞行状态配平的攻角和升降舵偏角存储-------------%%   
    resultalfaelevator(i,1) = Result_alpha;
    resultalfaelevator(i,2) = Result_elevator;
 
 %%---------求解推力，用以求配平油门开度-------------%%    
    Cx = interp2(given_Elevator,given_Alpha,given_Cx,Result_elevator,Result_alpha,'spline');
    X = 0.5*rou*V0^2*S*Cx;
    T = m*g*sin(Result_alpha/r2d) - X;

 %%------------根据X轴力平衡进行配平----------------%%    
    for Throtte=0:0.1:1
        x=fsolve('trimfunction1',Throtte,optimset('Display','off'));
        if abs(trimfunction1(x))<=1e-4
            Result_Throtte=x;
            break;
        end
    end
    
%%---------将每一种飞行状态配平的油门开度存储-------------%%     
    resultalfaelevator(i,3) = Result_Throtte;
    
    end

   subplot(131); plot(state(:,1),resultalfaelevator(:,1));
   xlabel('飞机速度（米/秒）'); ylabel('配平攻角（°）');
   subplot(132); plot(state(:,1),resultalfaelevator(:,2));
   xlabel('飞机速度（米/秒）'); ylabel('配平舵偏角elevator（°）');
   subplot(133); plot(state(:,1),resultalfaelevator(:,3));
   xlabel('飞机速度（米/秒）'); ylabel('配平发动机油门开度（0-1）');
